# ModSecurity configuration overrides for ProtecLiter

# Engine on
SecRuleEngine On

# Request body access
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# Response body access
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# Temporary files
SecTmpDir /tmp/
SecDataDir /tmp/

# Audit logging
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsecurity/audit.log

# Debug log (disable in production)
SecDebugLog /var/log/modsecurity/debug.log
SecDebugLogLevel 0

# Rules settings
SecArgumentSeparator &
SecCookieFormat 0
SecUnicodeMapFile unicode.mapping 20127
SecStatusEngine On

# Custom rules for ProtecLiter
# Allow JSON content type
SecRule REQUEST_HEADERS:Content-Type "application/json" \
    "id:1000,phase:1,pass,nolog,ctl:requestBodyProcessor=JSON"

# Whitelist internal health checks
SecRule REMOTE_ADDR "@ipMatch 127.0.0.1,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16" \
    "id:1002,phase:1,pass,nolog,ctl:ruleEngine=Off"

# Allow Stripe webhook signatures in headers
SecRule REQUEST_URI "@beginsWith /api/v1/webhooks/stripe" \
    "id:1003,phase:1,pass,nolog,ctl:ruleRemoveById=920230"

# Increase score threshold for API
SecAction "id:1004,phase:1,pass,nolog,setvar:tx.inbound_anomaly_score_threshold=10"

# Paranoia level (1-4, higher = stricter)
SecAction "id:900000,phase:1,pass,t:none,nolog,setvar:tx.paranoia_level=2"

# Enable blocking mode
SecAction "id:900001,phase:1,pass,t:none,nolog,setvar:tx.blocking_paranoia_level=2"

# Anomaly thresholds
SecAction "id:900110,phase:1,pass,t:none,nolog,setvar:tx.inbound_anomaly_score_threshold=10"
SecAction "id:900111,phase:1,pass,t:none,nolog,setvar:tx.outbound_anomaly_score_threshold=5"
