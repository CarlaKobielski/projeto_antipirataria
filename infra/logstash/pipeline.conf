input {
  beats {
    port => 5044
  }
}

filter {
  if [fields][service] {
    mutate {
      add_field => { "service" => "%{[fields][service]}" }
    }
  }

  # Parse JSON logs from Node.js services
  if [message] =~ /^\{/ {
    json {
      source => "message"
      target => "parsed"
    }

    if [parsed][level] {
      mutate {
        add_field => { "level" => "%{[parsed][level]}" }
      }
    }

    if [parsed][message] {
      mutate {
        replace => { "message" => "%{[parsed][message]}" }
      }
    }

    if [parsed][timestamp] {
      date {
        match => [ "[parsed][timestamp]", "ISO8601" ]
        target => "@timestamp"
      }
    }

    if [parsed][context] {
      mutate {
        add_field => { "context" => "%{[parsed][context]}" }
      }
    }

    if [parsed][requestId] {
      mutate {
        add_field => { "request_id" => "%{[parsed][requestId]}" }
      }
    }

    if [parsed][userId] {
      mutate {
        add_field => { "user_id" => "%{[parsed][userId]}" }
      }
    }

    if [parsed][tenantId] {
      mutate {
        add_field => { "tenant_id" => "%{[parsed][tenantId]}" }
      }
    }

    mutate {
      remove_field => [ "parsed" ]
    }
  }

  # Grok for nginx access logs
  if [fields][type] == "nginx-access" {
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
    }
    date {
      match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
      target => "@timestamp"
    }
  }

  # Add environment tag
  mutate {
    add_field => { "environment" => "${ENVIRONMENT:development}" }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logs-%{+YYYY.MM.dd}"
  }

  # Debug output
  # stdout { codec => rubydebug }
}
